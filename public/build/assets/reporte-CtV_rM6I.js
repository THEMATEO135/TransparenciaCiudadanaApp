document.addEventListener("DOMContentLoaded",function(){const e={form:document.getElementById("reportForm"),result:document.getElementById("result"),submitBtn:document.getElementById("submitBtn"),locationStatus:document.getElementById("locationStatus"),servicePrompt:document.getElementById("servicePrompt"),localidadSelect:document.getElementById("localidad"),barrioSelect:document.getElementById("barrio"),latInput:document.getElementById("latitude"),lngInput:document.getElementById("longitude"),servicioInput:document.getElementById("servicio_id"),ciudadInput:document.getElementById("ciudad_id"),proveedorInput:document.getElementById("proveedor_id"),departamentoModal:document.getElementById("departamentoModal"),ciudadModal:document.getElementById("ciudadModal"),proveedorModal:document.getElementById("proveedorModal"),departamentosList:document.getElementById("departamentosList"),ciudadesList:document.getElementById("ciudadesList"),proveedoresList:document.getElementById("proveedoresList"),departamentoSearch:document.getElementById("departamentoSearch"),ciudadSearch:document.getElementById("ciudadSearch"),proveedorSearch:document.getElementById("proveedorSearch"),skipProveedorBtn:document.getElementById("skipProveedorBtn"),locationAlert:document.getElementById("locationAlert")};let t=!1,o=[],n=[],a=[],r=null,s=null,i=null,c=null;const d="https://serviciosgis.catastrobogota.gov.co/arcgis/rest/services/ordenamientoterritorial/entidadterritorial/MapServer/0/query";function l(){const t=document.getElementById("reportForm");if(!t)return;t.querySelectorAll('input:not([type="hidden"]), textarea, select').forEach(e=>{e.disabled=!0}),e.submitBtn&&(e.submitBtn.disabled=!0),e.servicePrompt&&(e.servicePrompt.style.display="flex")}function u(e){e&&(e.classList.add("active"),document.body.style.overflow="hidden")}function m(e){e&&(e.classList.remove("active"),document.body.style.overflow="auto")}function p(t){e.departamentosList&&(e.departamentosList.innerHTML="",0!==t.length?t.forEach(t=>{const n=document.createElement("div");n.className="departamento-card";const a=`/img/banderas/departamentos/${t.nombre.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,"-")}.png`;n.innerHTML=`\n            <div class="departamento-icon">\n                <img src="${a}" \n                    alt="${t.nombre}" \n                    onerror="this.onerror=null;this.src='/img/banderas/colombia.png';" \n                    class="bandera-img">\n            </div>\n            <div class="departamento-name">${t.nombre}</div>\n            <div class="departamento-count">${t.count} ${1===t.count?"municipio":"municipios"}</div>\n        `,n.addEventListener("click",()=>function(t){r=t,m(e.departamentoModal);const n=o.filter(e=>e.departamento===t.nombre);v(n);const a=document.querySelector("#departamentoSeleccionado strong");a&&(a.textContent=t.nombre);u(e.ciudadModal)}(t)),e.departamentosList.appendChild(n)}):e.departamentosList.innerHTML='<p style="text-align: center; color: #6c757d; padding: 2rem;">No se encontraron departamentos</p>')}function v(t){e.ciudadesList&&(e.ciudadesList.innerHTML="",0!==t.length?t.forEach(t=>{const o=document.createElement("div");o.className="ciudad-card";const n=`/img/banderas/ciudades/${t.nombre.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,"-")}.png`,r=`/img/banderas/departamentos/${t.departamento.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,"-")}.png`;o.innerHTML=`\n            <div class="ciudad-icon">\n                <img src="${n}" \n                    alt="${t.nombre}" \n                    onerror="this.onerror=null;this.src='${r}';this.onerror=function(){this.src='/img/banderas/colombia.png';};" \n                    class="bandera-img">\n            </div>\n            <div class="ciudad-name">${t.nombre}</div>\n            <div class="ciudad-departamento">${t.departamento}</div>\n        `,o.addEventListener("click",()=>async function(t){s=t,e.ciudadInput.value=t.id,m(e.ciudadModal),await async function(t,o){if(!e.proveedoresList)return;e.proveedoresList.innerHTML='<p style="text-align: center; color: #6c757d; padding: 2rem;">Cargando proveedores...</p>';try{const n=await fetch(`/api/proveedores?ciudad_id=${t}&servicio_id=${o}`);if(!n.ok)throw new Error(`Error HTTP: ${n.status}`);const r=await n.json();r.success&&r.data&&r.data.length>0?(a=r.data,g(a)):(a=[],e.proveedoresList.innerHTML='<p style="text-align: center; color: #6c757d; padding: 2rem;">No hay proveedores disponibles para esta ciudad y servicio</p>')}catch(n){a=[],e.proveedoresList.innerHTML='<p style="text-align: center; color: #e74c3c; padding: 2rem;">Error al cargar proveedores</p>'}}(t.id,e.servicioInput.value),u(e.proveedorModal);const o=document.querySelector("#ciudadSeleccionada strong");o&&(o.textContent=`${t.nombre}, ${t.departamento}`)}(t)),e.ciudadesList.appendChild(o)}):e.ciudadesList.innerHTML='<p style="text-align: center; color: #6c757d; padding: 2rem;">No se encontraron ciudades</p>')}function g(t){e.proveedoresList&&(e.proveedoresList.innerHTML="",0!==t.length?t.forEach(t=>{const o=document.createElement("div");o.className="proveedor-card",o.innerHTML=`\n                <div class="proveedor-logo-container">\n                    ${t.logo_url?`<img src="${t.logo_url}" alt="${t.nombre}" class="proveedor-logo" onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div class=\\'proveedor-placeholder\\'><i class=\\'fas fa-building\\'></i></div>';">`:'<div class="proveedor-placeholder"><i class="fas fa-building"></i></div>'}\n                </div>\n                <div class="proveedor-name">${t.nombre}</div>\n                ${t.telefono||t.email?`<div class="proveedor-info">\n                        ${t.telefono?`<div>📞 ${t.telefono}</div>`:""}\n                        ${t.email?`<div>📧 ${t.email}</div>`:""}\n                    </div>`:""}\n            `,o.addEventListener("click",()=>y(t)),e.proveedoresList.appendChild(o)}):e.proveedoresList.innerHTML='<p style="text-align: center; color: #6c757d; padding: 2rem;">No se encontraron proveedores</p>')}function y(t){e.proveedorInput.value=t?t.id:"",m(e.proveedorModal),function(t){const o={1:"ENERGÍA ELÉCTRICA",2:"INTERNET",3:"GAS NATURAL",4:"ACUEDUCTO"},n=e.servicioInput.value,a=o[n]||"-",r=t?t.nombre.toUpperCase():"SIN ESPECIFICAR",i=s?s.nombre.toUpperCase():"-",c=document.getElementById("summaryServicio"),d=document.getElementById("summaryProveedor"),l=document.getElementById("summaryCiudad"),u=document.getElementById("selectionSummary");c&&(c.textContent=a);d&&(d.textContent=r);l&&(l.textContent=i);u&&(u.style.display="block")}(t),function(){const t=document.getElementById("reportForm");if(!t)return;t.querySelectorAll('input:not([type="hidden"]), textarea, select, button').forEach(e=>{e.disabled=!1}),e.servicePrompt&&(e.servicePrompt.style.display="none"),window.innerWidth<992&&t.scrollIntoView({behavior:"smooth"});const o=document.getElementById("nombres");o&&o.focus()}()}function h(e,t,o){const n={1:{lat:4.710989,lng:-74.072092,radius:50},2:{lat:6.244203,lng:-75.581212,radius:40},3:{lat:3.451647,lng:-76.531985,radius:40},4:{lat:10.963889,lng:-74.796387,radius:35},5:{lat:10.391049,lng:-75.479426,radius:30}}[o];if(!n)return!0;const a=(n.lat-e)*Math.PI/180,r=(n.lng-t)*Math.PI/180,s=Math.sin(a/2)*Math.sin(a/2)+Math.cos(e*Math.PI/180)*Math.cos(n.lat*Math.PI/180)*Math.sin(r/2)*Math.sin(r/2);return 6371*(2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)))<=n.radius}function f(){e.locationAlert&&(e.locationAlert.classList.add("show"),setTimeout(()=>{S&&S()},2e3))}l(),e.departamentoSearch&&e.departamentoSearch.addEventListener("input",e=>{const t=e.target.value.toLowerCase();p(n.filter(e=>e.nombre.toLowerCase().includes(t)))}),e.ciudadSearch&&e.ciudadSearch.addEventListener("input",e=>{const t=e.target.value.toLowerCase();v(o.filter(e=>e.nombre.toLowerCase().includes(t)||e.departamento.toLowerCase().includes(t)))}),e.proveedorSearch&&e.proveedorSearch.addEventListener("input",e=>{const t=e.target.value.toLowerCase();g(a.filter(e=>e.nombre.toLowerCase().includes(t)))}),e.skipProveedorBtn&&e.skipProveedorBtn.addEventListener("click",()=>{y(null)}),window.selectService=function(o,n){const a=document.getElementById("servicio_id");if(!a)return;a.value={energia:1,internet:2,gas:3,agua:4}[o]||1,document.querySelectorAll(".service-card").forEach(e=>{e.classList.remove("selected")});const r=n.target.closest(".service-card");r&&r.classList.add("selected"),t=!0,u(e.departamentoModal)},window.closeLocationAlert=function(){e.locationAlert&&e.locationAlert.classList.remove("show")},async function(){try{const t=new URLSearchParams({where:"1=1",outFields:"LOCALIDAD",returnDistinctValues:"true",orderByFields:"LOCALIDAD",f:"json",outSR:"4326"}),o=await fetch(`${d}?${t}`);if(!o.ok)throw new Error(`Error HTTP: ${o.status}`);const n=await o.json(),a=e.localidadSelect;if(!a)return;if(a.innerHTML='<option value="">Selecciona una localidad</option>',n&&n.features&&n.features.length>0){const e=n.features.map(e=>e.attributes?.LOCALIDAD).filter(e=>e&&""!==e.trim()).sort((e,t)=>e.localeCompare(t,"es",{sensitivity:"base"}));[...new Set(e)].forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,a.appendChild(t)})}else{["USAQUÉN","CHAPINERO","SANTA FE","SAN CRISTÓBAL","USME","TUNJUELITO","BOSA","KENNEDY","FONTIBÓN","ENGATIVÁ","SUBA","BARRIOS UNIDOS","TEUSAQUILLO","LOS MÁRTIRES","ANTONIO NARIÑO","PUENTE ARANDA","LA CANDELARIA","RAFAEL URIBE URIBE","CIUDAD BOLÍVAR","SUMAPAZ"].forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,a.appendChild(t)})}}catch(t){}}(),async function(){try{const e=await fetch("/api/ciudades");if(!e.ok)throw new Error(`Error HTTP: ${e.status}`);const t=await e.json();if(t.success&&t.data){o=t.data;const e={};t.data.forEach(t=>{e[t.departamento]||(e[t.departamento]={nombre:t.departamento,count:0}),e[t.departamento].count++}),n=Object.values(e).sort((e,t)=>e.nombre.localeCompare(t.nombre,"es")),p(n)}}catch(t){e.departamentosList&&(e.departamentosList.innerHTML='<p style="text-align: center; color: #e74c3c; padding: 2rem;">Error al cargar departamentos</p>')}}(),e.localidadSelect&&e.localidadSelect.addEventListener("change",t=>{const o=t.target.value;o?async function(t){try{const o=e.barrioSelect;if(!o)return;o.disabled=!0,o.innerHTML='<option value="">Cargando barrios...</option>';const n=encodeURIComponent(`LOCALIDAD = '${t.replace(/'/g,"''")}'`),a=new URLSearchParams({where:n,outFields:"BARRIOCOMU",returnDistinctValues:"true",orderByFields:"BARRIOCOMU",f:"json",outSR:"4326"}),r=await fetch(`${d}?${a}`);if(!r.ok)throw new Error(`Error HTTP: ${r.status}`);const s=await r.json();if(o.innerHTML='<option value="">Selecciona un barrio</option>',s&&s.features&&s.features.length>0){const e=s.features.map(e=>e.attributes?.BARRIOCOMU).filter(e=>e&&""!==e.trim()).sort((e,t)=>e.localeCompare(t,"es",{sensitivity:"base"}));[...new Set(e)].forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,o.appendChild(t)})}else o.innerHTML='<option value="">No se encontraron barrios</option>';o.disabled=!1}catch(o){const t=e.barrioSelect;t&&(t.innerHTML='<option value="">Error cargando barrios</option>',t.disabled=!1)}}(o):e.barrioSelect&&(e.barrioSelect.innerHTML='<option value="">Selecciona un barrio</option>',e.barrioSelect.disabled=!0)});const E=document.getElementById("closeFromDepartamento");E&&E.addEventListener("click",()=>{m(e.departamentoModal),document.querySelectorAll(".service-card").forEach(e=>{e.classList.remove("selected")}),e.servicioInput.value="",t=!1});const I=document.getElementById("backFromCiudad");I&&I.addEventListener("click",()=>{m(e.ciudadModal),u(e.departamentoModal)});const b=document.getElementById("backFromProveedor");function S(){const t=document.getElementById("mapSelector"),o=e.locationStatus,n=document.getElementById("locationStatusText");if(t){if(t.style.display="block",o&&(o.style.display="block",o.style.color="var(--primary-color)"),n&&(n.textContent="Por favor, selecciona tu ubicación en el mapa."),!i){let t=4.60971,a=-74.08175;i=L.map("map").setView([t,a],12),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap contributors"}).addTo(i),i.on("click",function(t){const a=t.latlng.lat,r=t.latlng.lng;e.latInput.value=a.toFixed(6),e.lngInput.value=r.toFixed(6),c&&i.removeLayer(c),c=L.marker([a,r]).addTo(i),n&&(n.textContent="Ubicación seleccionada correctamente en el mapa."),o&&(o.style.color="var(--success-color)"),closeLocationAlert()});const r=document.getElementById("mapSearch");r&&r.addEventListener("keypress",function(t){if("Enter"===t.key){t.preventDefault();const a=this.value;if(a){const t=s?`${a}, ${s.nombre}, Colombia`:`${a}, Colombia`;fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(t)}`).then(e=>e.json()).then(t=>{if(t&&t.length>0){const a=parseFloat(t[0].lat),r=parseFloat(t[0].lon);i.setView([a,r],16),c&&i.removeLayer(c),c=L.marker([a,r]).addTo(i),e.latInput.value=a.toFixed(6),e.lngInput.value=r.toFixed(6),n&&(n.textContent="Ubicación encontrada y seleccionada."),o&&(o.style.color="var(--success-color)")}else alert("No se encontró la dirección. Intenta con otra búsqueda.")}).catch(e=>{alert("Error al buscar la dirección.")})}}})}setTimeout(()=>{i&&i.invalidateSize()},100)}}async function B(){const o=new FormData(e.form);e.latInput&&e.latInput.value&&o.set("latitude",e.latInput.value),e.lngInput&&e.lngInput.value&&o.set("longitude",e.lngInput.value);const n=document.querySelector('meta[name="csrf-token"]');n&&o.append("_token",n.getAttribute("content"));try{const a=await fetch("/reportes",{method:"POST",headers:{"X-CSRF-TOKEN":n?n.getAttribute("content"):"",Accept:"application/json"},body:o});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const d=await a.json();e.submitBtn.classList.remove("loading"),e.submitBtn.disabled=!1,d.ok?(e.result.textContent="¡Reporte enviado exitosamente! ID: "+d.id,e.result.className="result-message success show",setTimeout(()=>{e.form.reset(),e.result.classList.remove("show"),document.querySelectorAll(".service-card").forEach(e=>{e.classList.remove("selected")}),r=null,s=null,e.ciudadInput.value="",e.proveedorInput.value="";const o=document.getElementById("selectionSummary");o&&(o.style.display="none");const n=e.locationStatus,a=document.getElementById("mapSelector");n&&(n.style.display="none"),a&&(a.style.display="none"),i&&c&&(i.removeLayer(c),c=null),closeLocationAlert(),l(),t=!1},5e3)):(e.result.textContent="Error al enviar el reporte: "+(d.error||JSON.stringify(d)),e.result.className="result-message error show")}catch(a){e.submitBtn.classList.remove("loading"),e.submitBtn.disabled=!1,e.result.textContent="Error de conexión: "+a.message,e.result.className="result-message error show"}}b&&b.addEventListener("click",()=>{m(e.proveedorModal),u(e.ciudadModal)}),e.form&&e.form.addEventListener("submit",async t=>{if(t.preventDefault(),e.submitBtn.classList.add("loading"),e.submitBtn.disabled=!0,e.result.classList.remove("show"),e.latInput.value&&e.lngInput.value){if(e.ciudadInput.value){h(parseFloat(e.latInput.value),parseFloat(e.lngInput.value),parseInt(e.ciudadInput.value))||f()}}else{const t=e.locationStatus,n=document.getElementById("locationStatusText");t&&(t.style.display="block"),t&&(t.style.color="var(--primary-color)"),n&&(n.textContent="Obteniendo tu ubicación...");try{const o=await new Promise((e,t)=>{if(!window.isSecureContext&&"localhost"!==location.hostname)return void t(new Error("HTTPS requerido"));const o={enableHighAccuracy:!0,timeout:1e4,maximumAge:0};navigator.geolocation?navigator.geolocation.getCurrentPosition(function(t){e({latitude:t.coords.latitude,longitude:t.coords.longitude})},function(e){t(e)},o):t(new Error("Geolocalización no soportada"))});if(e.latInput.value=o.latitude.toFixed(6),e.lngInput.value=o.longitude.toFixed(6),t&&(t.style.color="var(--success-color)"),n&&(n.textContent="Ubicación obtenida correctamente."),e.ciudadInput.value){if(!h(parseFloat(o.latitude),parseFloat(o.longitude),parseInt(e.ciudadInput.value)))return f(),e.submitBtn.classList.remove("loading"),e.submitBtn.disabled=!1,e.result.textContent="Por favor, verifica tu ubicación en el mapa antes de enviar.",void(e.result.className="result-message error show")}return void setTimeout(()=>B(),500)}catch(o){return S(),e.submitBtn.classList.remove("loading"),e.submitBtn.disabled=!1,e.result.textContent="Por favor, selecciona tu ubicación en el mapa antes de enviar el reporte.",void(e.result.className="result-message error show")}}B()}),document.querySelectorAll(".form-control, .form-select").forEach(e=>{e.addEventListener("focus",function(){this.parentElement.style.transform="scale(1.02)"}),e.addEventListener("blur",function(){this.parentElement.style.transform="scale(1)"})});const C=document.getElementById("descripcion");C&&C.addEventListener("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"})});
